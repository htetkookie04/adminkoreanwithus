generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Role {
  id                  Int                  @id @default(autoincrement())
  name                String               @unique
  description         String?
  createdAt           DateTime             @default(now()) @map("created_at")
  updatedAt           DateTime             @updatedAt @map("updated_at")
  rolePermissions     RolePermission[]
  roleMenuPermissions RoleMenuPermission[]
  users               User[]

  @@map("roles")
}

model Permission {
  id              Int              @id @default(autoincrement())
  name            String           @unique
  description     String?
  resource        String
  action          String
  rolePermissions RolePermission[]

  @@map("permissions")
}

model RolePermission {
  roleId       Int        @map("role_id")
  permissionId Int        @map("permission_id")
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

model RoleMenuPermission {
  id        Int      @id @default(autoincrement())
  roleId    Int      @map("role_id")
  menuKey   String   @map("menu_key")
  menuLabel String   @map("menu_label")
  menuPath  String   @map("menu_path")
  menuIcon  String?  @map("menu_icon")
  sortOrder Int      @default(0) @map("sort_order")
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, menuKey])
  @@index([roleId])
  @@index([enabled])
  @@map("role_menu_permissions")
}

model User {
  id                Int            @id @default(autoincrement())
  email             String         @unique
  passwordHash      String?        @map("password_hash")
  firstName         String?        @map("first_name")
  lastName          String?        @map("last_name")
  phone             String?
  roleId            Int            @default(4) @map("role_id")
  status            String         @default("active")
  lastLoginAt       DateTime?      @map("last_login_at")
  createdAt         DateTime       @default(now()) @map("created_at")
  updatedAt         DateTime       @updatedAt @map("updated_at")
  activityLogs      ActivityLog[]
  aiReports         AiReport[]
  coursesCreated    Course[]       @relation("CourseCreator")
  enrollments       Enrollment[]
  feedback          Feedback[]
  inquiriesAssigned Inquiry[]      @relation("InquiryAssignee")
  inquiryReplies    InquiryReply[]
  lecturesUploaded  Lecture[]
  mediaUploaded     Media[]
  schedules         Schedule[]
  settingsUpdated   Setting[]
  role              Role           @relation(fields: [roleId], references: [id])
  waitlistEntries   Waitlist[]
  financeTransactionsCreated FinanceTransaction[] @relation("FinanceTransactionCreator")
  bookSalesCreated  BookSale[]     @relation("BookSaleCreator")
  payrollCreated    Payroll[]      @relation("PayrollCreator")
  payrollAsTeacher  Payroll[]      @relation("PayrollTeacher")

  @@index([email])
  @@index([roleId], map: "users_role_idx")
  @@index([status])
  @@map("users")
}

model Course {
  id          Int           @id @default(autoincrement())
  title       String
  slug        String        @unique
  description String?
  level       String?
  capacity    Int           @default(0)
  price       Decimal       @default(0) @db.Decimal(10, 2)
  currency    String        @default("MMK")
  active      Boolean       @default(true)
  createdBy   Int?          @map("created_by")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")
  courseMedia CourseMedia[]
  creator     User?         @relation("CourseCreator", fields: [createdBy], references: [id])
  enrollments Enrollment[]
  feedback    Feedback[]
  lectures    Lecture[]
  schedules   Schedule[]
  waitlist    Waitlist[]

  @@index([slug])
  @@index([active])
  @@index([level])
  @@map("courses")
}

model Schedule {
  id          Int          @id @default(autoincrement())
  courseId    Int          @map("course_id")
  teacherId   Int?         @map("teacher_id")
  startTime   DateTime?    @map("start_time") @db.Timestamptz(6)
  endTime     DateTime?    @map("end_time") @db.Timestamptz(6)
  timezone    String       @default("Asia/Singapore")
  capacity    Int?
  location    String?
  status      String       @default("scheduled")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")
  enrollments Enrollment[]
  feedback    Feedback[]
  course      Course       @relation(fields: [courseId], references: [id], onDelete: Cascade)
  teacher     User?        @relation(fields: [teacherId], references: [id])
  waitlist    Waitlist[]

  @@index([courseId], map: "schedules_course_idx")
  @@index([teacherId], map: "schedules_teacher_idx")
  @@index([startTime])
  @@index([status])
  @@map("schedules")
}

model Enrollment {
  id            Int       @id @default(autoincrement())
  userId        Int?      @map("user_id")
  courseId      Int?      @map("course_id")
  scheduleId    Int?      @map("schedule_id")
  status        String    @default("pending")
  enrolledAt    DateTime  @default(now()) @map("enrolled_at")
  notes         String?
  source        String?
  paymentStatus String    @default("unpaid") @map("payment_status")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  course        Course?   @relation(fields: [courseId], references: [id])
  schedule      Schedule? @relation(fields: [scheduleId], references: [id])
  user          User?     @relation(fields: [userId], references: [id])
  payments      Payment[]

  @@unique([userId, scheduleId])
  @@index([courseId], map: "enrollments_course_idx")
  @@index([userId], map: "enrollments_user_idx")
  @@index([scheduleId], map: "enrollments_schedule_idx")
  @@index([status])
  @@index([paymentStatus])
  @@index([enrolledAt])
  @@map("enrollments")
}

model Payment {
  id           Int         @id @default(autoincrement())
  enrollmentId Int?        @map("enrollment_id")
  amount       Decimal     @db.Decimal(10, 2)
  currency     String      @default("MMK")
  method       String?
  providerRef  String?     @map("provider_ref")
  status       String      @default("pending")
  paidAt       DateTime?   @map("paid_at") @db.Timestamptz(6)
  refundedAt   DateTime?   @map("refunded_at") @db.Timestamptz(6)
  metadata     Json?
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")
  enrollment   Enrollment? @relation(fields: [enrollmentId], references: [id])

  @@index([enrollmentId], map: "payments_enrollment_idx")
  @@index([status])
  @@index([providerRef])
  @@index([paidAt])
  @@map("payments")
}

model Inquiry {
  id         Int            @id @default(autoincrement())
  name       String?
  email      String?
  phone      String?
  subject    String?
  message    String?
  status     String         @default("new")
  assignedTo Int?           @map("assigned_to")
  priority   String         @default("normal")
  source     String?
  metadata   Json?
  createdAt  DateTime       @default(now()) @map("created_at")
  updatedAt  DateTime       @updatedAt @map("updated_at")
  assignee   User?          @relation("InquiryAssignee", fields: [assignedTo], references: [id])
  replies    InquiryReply[]

  @@index([status])
  @@index([assignedTo])
  @@index([email])
  @@index([createdAt])
  @@map("inquiries")
}

model InquiryReply {
  id         Int      @id @default(autoincrement())
  inquiryId  Int      @map("inquiry_id")
  userId     Int?     @map("user_id")
  message    String
  isInternal Boolean  @default(false) @map("is_internal")
  createdAt  DateTime @default(now()) @map("created_at")
  inquiry    Inquiry  @relation(fields: [inquiryId], references: [id], onDelete: Cascade)
  user       User?    @relation(fields: [userId], references: [id])

  @@index([inquiryId], map: "inquiry_replies_inquiry_idx")
  @@map("inquiry_replies")
}

model Feedback {
  id         Int       @id @default(autoincrement())
  userId     Int?      @map("user_id")
  courseId   Int?      @map("course_id")
  scheduleId Int?      @map("schedule_id")
  rating     Int?
  comment    String?
  status     String    @default("pending")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  course     Course?   @relation(fields: [courseId], references: [id])
  schedule   Schedule? @relation(fields: [scheduleId], references: [id])
  user       User?     @relation(fields: [userId], references: [id])

  @@index([userId], map: "feedback_user_idx")
  @@index([courseId], map: "feedback_course_idx")
  @@index([rating])
  @@map("feedback")
}

model Media {
  id          Int           @id @default(autoincrement())
  filename    String
  url         String
  mimeType    String?       @map("mime_type")
  sizeBytes   Int?          @map("size_bytes")
  uploadedBy  Int?          @map("uploaded_by")
  folder      String?
  metadata    Json?
  createdAt   DateTime      @default(now()) @map("created_at")
  courseMedia CourseMedia[]
  uploader    User?         @relation(fields: [uploadedBy], references: [id])

  @@index([uploadedBy])
  @@index([folder])
  @@map("media")
}

model CourseMedia {
  courseId Int    @map("course_id")
  mediaId  Int    @map("media_id")
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  media    Media  @relation(fields: [mediaId], references: [id], onDelete: Cascade)

  @@id([courseId, mediaId])
  @@map("course_media")
}

model ActivityLog {
  id           BigInt   @id @default(autoincrement())
  userId       Int?     @map("user_id")
  action       String
  resourceType String?  @map("resource_type")
  resourceId   Int?     @map("resource_id")
  meta         Json?
  ipAddress    String?  @map("ip_address") @db.Inet
  userAgent    String?  @map("user_agent")
  createdAt    DateTime @default(now()) @map("created_at")
  user         User?    @relation(fields: [userId], references: [id])

  @@index([userId], map: "activity_logs_user_idx")
  @@index([resourceType, resourceId], map: "activity_logs_resource_idx")
  @@index([action])
  @@index([createdAt])
  @@map("activity_logs")
}

model AiReport {
  id          Int      @id @default(autoincrement())
  name        String?
  reportType  String   @map("report_type")
  inputMeta   Json?    @map("input_meta")
  resultText  String?  @map("result_text")
  resultData  Json?    @map("result_data")
  model       String?
  status      String   @default("completed")
  generatedAt DateTime @default(now()) @map("generated_at")
  createdBy   Int?     @map("created_by")
  creator     User?    @relation(fields: [createdBy], references: [id])

  @@index([reportType], map: "ai_reports_type_idx")
  @@index([generatedAt])
  @@map("ai_reports")
}

model Setting {
  key         String   @id
  value       Json
  description String?
  updatedBy   Int?     @map("updated_by")
  updatedAt   DateTime @updatedAt @map("updated_at")
  updater     User?    @relation(fields: [updatedBy], references: [id])

  @@map("settings")
}

model Waitlist {
  id         Int       @id @default(autoincrement())
  userId     Int       @map("user_id")
  courseId   Int       @map("course_id")
  scheduleId Int?      @map("schedule_id")
  position   Int?
  notifiedAt DateTime? @map("notified_at") @db.Timestamptz(6)
  createdAt  DateTime  @default(now()) @map("created_at")
  course     Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  schedule   Schedule? @relation(fields: [scheduleId], references: [id])
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([courseId], map: "waitlist_course_idx")
  @@index([scheduleId], map: "waitlist_schedule_idx")
  @@map("waitlist")
}

model Lecture {
  id              Int      @id @default(autoincrement())
  courseId        Int      @map("course_id")
  title           String
  description     String?
  videoUrl        String?  @map("video_url")
  pdfUrl          String?  @map("pdf_url")
  resourceLinkUrl String?  @map("resource_link_url")
  uploadedBy      Int      @map("uploaded_by")
  roleOfUploader  String   @map("role_of_uploader")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  course          Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  uploader        User     @relation(fields: [uploadedBy], references: [id], onDelete: SetNull)

  @@index([courseId], map: "lectures_course_idx")
  @@index([uploadedBy])
  @@index([createdAt])
  @@map("lectures")
}

model Timetable {
  id          Int      @id @default(autoincrement())
  courseName  String   @map("course_name")
  level       String
  dayOfWeek   String   @map("day_of_week")
  startTime   DateTime @map("start_time") @db.Time(6)
  endTime     DateTime @map("end_time") @db.Time(6)
  teacherName String   @map("teacher_name")
  status      String   @default("active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([dayOfWeek])
  @@index([status])
  @@index([startTime])
  @@map("timetable")
}

model Gallery {
  id        Int      @id @default(autoincrement())
  imageUrl  String   @map("image_url")
  caption   String?
  sortOrder Int      @default(0) @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([sortOrder])
  @@index([createdAt])
  @@map("gallery")
}

// ========== Finance Module ==========
enum FinanceType {
  REVENUE
  EXPENSE
}

enum PaymentMethod {
  CASH
  KBZPAY
  WAVEPAY
  BANK
  CARD
}

enum PayrollStatus {
  DRAFT
  CONFIRMED
  PAID
}

enum Currency {
  MMK
  KRW
  USD
}

model FinanceCategory {
  id        String            @id @default(uuid())
  type      FinanceType
  name      String
  parentId  String?           @map("parent_id")
  isActive  Boolean           @default(true) @map("is_active")
  createdAt DateTime         @default(now()) @map("created_at")
  updatedAt DateTime         @updatedAt @map("updated_at")
  parent    FinanceCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children  FinanceCategory[] @relation("CategoryHierarchy")
  transactions FinanceTransaction[]

  @@index([type])
  @@index([parentId])
  @@index([isActive])
  @@map("finance_categories")
}

model FinanceTransaction {
  id              String           @id @default(uuid())
  type            FinanceType
  categoryId      String           @map("category_id")
  amount          Decimal          @db.Decimal(12, 2)
  currency        Currency         @default(MMK)
  paymentMethod   PaymentMethod    @map("payment_method")
  occurredAt      DateTime         @map("occurred_at") @db.Timestamptz(6)
  note            String?
  referenceType   String?          @map("reference_type")
  referenceId     String?          @map("reference_id")
  createdByUserId Int              @map("created_by_user_id")
  isDeleted       Boolean          @default(false) @map("is_deleted")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  category        FinanceCategory  @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  createdByUser   User             @relation("FinanceTransactionCreator", fields: [createdByUserId], references: [id], onDelete: Restrict)
  attachments     FinanceAttachment[]

  @@index([type, occurredAt])
  @@index([categoryId])
  @@index([createdByUserId])
  @@index([isDeleted])
  @@map("finance_transactions")
}

model FinanceAttachment {
  id            String           @id @default(uuid())
  transactionId String           @map("transaction_id")
  fileUrl       String           @map("file_url")
  fileName      String           @map("file_name")
  createdAt     DateTime         @default(now()) @map("created_at")
  transaction   FinanceTransaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@index([transactionId])
  @@map("finance_attachments")
}

model Book {
  id        String   @id @default(uuid())
  title     String
  sku       String?
  salePrice Decimal  @map("sale_price") @db.Decimal(10, 2)
  costPrice Decimal? @map("cost_price") @db.Decimal(10, 2)
  isActive  Boolean   @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  bookSaleItems BookSaleItem[]

  @@index([isActive])
  @@map("books")
}

model BookSale {
  id              String        @id @default(uuid())
  soldAt          DateTime      @map("sold_at") @db.Timestamptz(6)
  customerName    String?       @map("customer_name")
  paymentMethod   PaymentMethod @map("payment_method")
  currency        Currency      @default(MMK)
  totalAmount     Decimal       @map("total_amount") @db.Decimal(12, 2)
  profitAmount    Decimal?      @map("profit_amount") @db.Decimal(12, 2)
  createdByUserId Int           @map("created_by_user_id")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  createdByUser   User          @relation("BookSaleCreator", fields: [createdByUserId], references: [id], onDelete: Restrict)
  items          BookSaleItem[]

  @@index([soldAt])
  @@map("book_sales")
}

model BookSaleItem {
  id        String   @id @default(uuid())
  saleId    String   @map("sale_id")
  bookId    String   @map("book_id")
  qty       Int
  unitPrice Decimal  @map("unit_price") @db.Decimal(10, 2)
  sale      BookSale  @relation(fields: [saleId], references: [id], onDelete: Cascade)
  book      Book      @relation(fields: [bookId], references: [id], onDelete: Restrict)

  @@index([saleId])
  @@index([bookId])
  @@map("book_sale_items")
}

model Payroll {
  id               String        @id @default(uuid())
  teacherUserId    Int           @map("teacher_user_id")
  periodMonth      DateTime      @map("period_month") @db.Date
  baseSalary       Decimal       @map("base_salary") @db.Decimal(12, 2)
  bonus            Decimal       @default(0) @db.Decimal(12, 2)
  deduction        Decimal       @default(0) @db.Decimal(12, 2)
  netPay           Decimal       @map("net_pay") @db.Decimal(12, 2)
  status           PayrollStatus  @default(DRAFT)
  paidAt           DateTime?     @map("paid_at") @db.Timestamptz(6)
  paymentMethod    PaymentMethod? @map("payment_method")
  currency         Currency      @default(MMK)
  createdByUserId  Int           @map("created_by_user_id")
  createdAt        DateTime      @default(now()) @map("created_at")
  updatedAt        DateTime      @updatedAt @map("updated_at")
  teacherUser      User          @relation("PayrollTeacher", fields: [teacherUserId], references: [id], onDelete: Restrict)
  createdByUser    User          @relation("PayrollCreator", fields: [createdByUserId], references: [id], onDelete: Restrict)

  @@unique([teacherUserId, periodMonth])
  @@index([periodMonth])
  @@index([status])
  @@map("payroll")
}
